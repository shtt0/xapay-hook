# xapay-hooks

**Xahau ネットワーク上で PayPay のような決済体験を実現する PoC (Proof of Concept)**

`xapay-hooks`は、Xahau ネットワーク上で日本円ステーブルコインを用いた決済サービス「XApay」のバックエンドロジックを、**Xahau Hooks**で実装した Proof of Concept（概念実証）プロジェクトです。

## 1. XApay とは？

XApay は、多くの人が利用している「PayPay」のような手軽なキャッシュレス決済を、次世代のブロックチェーンである**Xahau ネットワーク**上で実現することを目指す決済サービスです。

- **コンセプト**: ユーザーが日常の買い物で、迅速かつスムーズに支払いを行える体験を提供します。
- **利用通貨**: 独自の日本円ステーブルコイン（テストコイン）を使用します。※今回開発では XAH を仮想 SC としてそのまま使用しました。
- **利用シーン**: 全国のスーパーマーケットや小売店での支払いを想定しています。
- **仕組み**: XApay はユーザーと店舗の間に立つ決済事業者です。ユーザーから預かった代金を、店舗が求めるタイミングでまとめて日本円で振り込みます。（※本プロジェクトでは振込部分はダミー画面で実装）

より詳細なコンセプトについては、以下の資料もご覧ください。

▶ **[コンセプト資料 (Canva)](https://www.canva.com/design/DAGqbpw0TtQ/7_sqrkE8oNG9mV0a_6EBpA/edit?utm_content=DAGqbpw0TtQ&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton)**

## 2. 技術的な特徴

本プロジェクトは、Xahau の先進的な機能を利用して、優れた UX（ユーザー体験）と高いセキュリティの両立を目指しています。

### Xahau Hooks によるスマートな決済処理

Xahau のスマートコントラクト機能である**Hook**に、決済ロジック（残高管理、署名検証、自動送金など）を直接書き込んでいます。これにより、中央集権的なサーバーに依存することなく、安全で自動化された取引を Xahau の台帳上で直接実行します。

### フックアカウントへのチャージによる UX 向上

ユーザーが支払いを行うたびにブロックチェーンへの署名（承認作業）をしていては、時間がかかり不便です。XApay ではユーザーは一度残高をチャージすれば、都度の署名なしでスムーズな支払いが可能になります。これにより、店舗のレジに人を滞留させず、既存の決済アプリと遜色ないユーザー体験を実現します。

### Web3Auth による簡単なアカウント開設

ユーザーは使い慣れたメールアドレスでログインするだけで、裏側で自動的に Xahau のアカウントが作成されます。暗号資産の知識がない方でも、簡単にサービスを使い始めることができます。※Google ログインを想定していましたが、今回は簡易に ID/PASS(test1/test1)でログインできます。

### 疑似決済秘匿

Hook の活用により個人 → 店舗への決済履歴の追跡を困難にし、安心して日常でもステーブルコイン決済を可能に。

具体的には、以下の点が実現され、プライバシーが保護されます。

- 取引の匿名化（誰が支払ったかの分離）: 外部からブロックチェーンを監視しても、「フックアカウントが運営アカウントに 1 XAH を送金した」という事実は見えても、その原資が Alice の残高であったことは直接的には分かりません。
- 決済情報の集約と抽象化: Alice が 100 円のジュースを 5 回買っても、ブロックチェーン上には「Alice → 店舗」の 100 円の取引が 5 件記録されるわけではありません。記録されるのは「Alice → フック」のチャージ（例：1000 円）と、「フック → 運営」の引き落とし（例：500 円）といった、より大きな単位の取引だけです。個別の細かな購買行動は、フックの内部状態（ステート）の変化として処理されるため、外部から追跡することが極めて困難になります。
- 関係性の秘匿: Alice がどの店舗（運営）のサービスを使ったのか、また、ある店舗がどの顧客（Alice、Bob、Carol...）から支払いを受けたのか、といった関係性がオンチェーンデータから直接結びつかなくなります。

## 3. Hook の動作フロー

ユーザー（例: Alice）が XApay を利用する際の、オンチェーンでの一連の流れです。

1. **チャージ (ユーザー)**

   - Alice が paypay 等と同様に銀行振込などで日本円を入金。
   - 運営は入金を確認後、Alice のアドレスにデビットカードのような概念で、ステーブルコインをアドレスに対して送金。（資金交換）
   - Alice は、Suica や Paypay の感覚でアドレスに保有している SC を決済用残高としてチャージ。チャージにフロントでの署名は不要で、徹底してブロックチェーンは意識させません。

2. **支払い (ユーザー)・店舗入金**

   - 店舗の POS 端末が Alice の 支払い用バーコードを読み取り、XApay の API 経由で決済をサービス運営者に通知します。（Paypay 等と同じ）
   - Hook が Alice のチャージ済残高から支払い額を差し引き、取引履歴をオンチェーンに記録します。この際も、Alice 自身の署名操作は不要です。
   - 売上は一度、中間決済業者としての本サービスが預かり、店舗側は希望のタイミングで日本円での銀行振込を依頼できます。（Paypay と同じ）
   - 将来的に、SC で受け取る（ユーザから直接送金を受けるも含めて）か、SC を取引先に債権（支払い）相殺のため送金してほしいといったニーズも、SC が日本の各企業で普及することであり得ると想像します。

3. **払い戻し・チャネル閉鎖 (ユーザー/運営)**
   - ユーザーは、チャージした残高のうち未利用分をいつでも自身のウォレットに払い戻すことができます。
   - 運営がチャネルを閉鎖する指示を出すと、Hook は内部台帳を参照し、未使用残高をユーザーへ自動的に送金（emit）して精算します。

## 4. 現在のステータスと課題

このプロジェクトは現在開発途上にあり、いくつかの課題が残っています。

### 🚨 [要修正] MEMO の判定ロジックの不具合

現在、Hook がトランザクションの`Memos`フィールドを正しく認識できないという重大な問題が発生しています。

- **問題**: トランザクションに`Memos`フィールドを含め、操作種別（`recharge`, `withdraw`など）を 16 進数で指定しても、Hook 側のロジックがそれを読み取れていません。
- **原因**: 送信側の JSON 形式は正しいと考えられるため、Hook のソースコード (`xapay.c`) における MEMO データの取得・比較処理に不具合がある可能性が高いです。
- **現在の挙動**: この問題により、意図した処理が実行されず、トランザクションが `Accepted (unhandled)` として扱われてしまいます。**このデバッグと修正が最優先課題です。**

```json
// 送信しているMemosフィールドの例
"Memos": [
  {
    "Memo": {
      "MemoData": "7265636861726765", // "recharge" の16進数表現
      "MemoType": "68757874657874",   // "huxtext" の16進数表現 (例)
      "MemoFormat": "74657874"         // "text" の16進数表現 (例)
    }
  }
]
```

### 今後のタスク

- 上記 MEMO 問題のデバッグ・修正
- テストシナリオの拡充とテストの自動化
- エラーハンドリングの強化

## 5. コントリビューション

このプロジェクトはまだ開発の初期段階です。バグ報告、機能提案、プルリクエストなど、あらゆるコントリビューションを歓迎します。
何かお気づきの点があれば、お気軽にご連絡ください。
